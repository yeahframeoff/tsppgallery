{% extends 'base-cf.html' %}

{% block title %} {% endblock %}

{% block style %}
    <style>
        .col-lg-4 > .affix.panel{
            width: 100%;
            height: 100%;
        }
        .media > div{
            display: inline-block;
        }

        .media > .media-body{
            width: 75%;
        }
    </style>
{% endblock %}

{% block script %}
    <script>
        $(function(){
            Genre = {
                genres: [],
                genresCopy: null,
                allGenres: [],
                freeGenres: [],

                saveGenres: function () {
                    this.genresCopy = this.genres.slice(0, this.genres.length);
                },

                restoreGenres: function () {
                    this.genres = this.genresCopy;
                },

                reportToServer: function (successCallback, failCallback) {
                    var success = false;
                    var genres_ids = $.map(this.genres, function(x) { return x.id; });
                    var stringified = genres_ids.join(',');
                    var This = this;
                    $.post("{% url 'exhibition-genres-update' xzibit.pk %}",
                            {'ids_order':stringified,
                             'csrfmiddlewaretoken':"{{ csrf_token }}"},
                            'json'
                    ).done(function(data) {
                        success = !!data.success;
                    }).always(function() {
                        if (!Array.isArray(successCallback))
                            successCallback = [successCallback];
                        if (!Array.isArray(failCallback))
                            failCallback = [failCallback];
                        var execute = success ? successCallback : failCallback;
                        for (var k in execute)
                            execute[k].call(This);
                    });
                },

                up: function (i) {
                    this.saveGenres();
                    var genres = this.genres;
                    if (i > 0) {
                        var genre = genres[i - 1];
                        genres[i - 1] = genres[i];
                        genres[i] = genre;
                    }
                    this.reportToServer(this.showList, this.restoreGenres);
                },

                down: function (i) {
                    this.saveGenres();
                    var genres = this.genres;
                    if (i < genres.length - 1) {
                        var genre = genres[i + 1];
                        genres[i + 1] = genres[i];
                        genres[i] = genre;
                    }
                    this.reportToServer(this.showList, this.restoreGenres);
                },

                remove: function (i) {
                    this.saveGenres();
                    this.genres.splice(i,1);
                    this.reportToServer(
                        [this.showList, this.refreshFree],
                        this.restoreGenres
                    );
                },

                add: function (i) {
                    this.saveGenres();
                    this.genres.push(this.freeGenres[i]);
                    this.reportToServer(
                        [this.showList, this.refreshFree],
                        this.restoreGenres
                    );
                },

                showList: function () {
                    var elem = $('#genreList');
                    elem.html('');
                    for (var i=0; i < this.genres.length; i++) {
                        elem.append(
                            '<li class="list-group-item" style="height: 56px; line-height: 34px;">'+
                            this.genres[i].name+
                            '<button type="button" class="btn btn-danger pull-right" style="margin-left: 4px"onclick="Genre.remove('+i+')">'+
                            '<span class="glyphicon glyphicon-remove"></span>'+
                            '</button>'+
                            '<div class="btn-group pull-right" role="group">'+
                            '<button type="button" class="btn btn-default"onclick="Genre.up('+i+')">'+
                            '<span class="glyphicon glyphicon-chevron-up"></span>'+
                            '</button>'+
                            '<button type="button" class="btn btn-default"onclick="Genre.down('+i+')">'+
                            '<span class="glyphicon glyphicon-chevron-down"></span>'+
                            '</button>'+
                            '</div>'+
                            '</li>'
                        );
                    }
                },

                showFreeList: function () {
                    var elem = $('#menu3');
                    elem.html('');
                    for (var i=0; i < this.freeGenres.length; i++){
                        elem.append(
                            '<li role="presentation" onclick="Genre.add('+i+')"><a>'+
                            this.freeGenres[i].name+
                            '</a></li>'
                        );
                    }
                },

                refreshFree: function () {
                    var t = this.allGenres.slice(0, this.allGenres.length);
                    var k;
                    for (var i =0; i < this.genres.length; i++) {
                        k = -1;
                        for (var j = 0; j < t.length; j++) {
                            if (t[j].id == this.genres[i].id) {
                                k = j;
                                break;
                            }
                        }
                        if (k >= 0)
                            t.splice(k, 1);
                    }
                    this.freeGenres = t;
                    this.showFreeList();
                },

                init: function(){
                    var This = this;
                    $.getJSON("{% url 'exhibition-genres' pk=xzibit.pk %}", function (data){
                        This.genres = data;
                        This.showList();
                        $.getJSON("{% url 'genres' %}",
                            function(data1){
                                This.allGenres = data1;
                                This.refreshFree();
                            });
                    })
                }
            };

            Genre.init();
        });
    </script>
{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-lg-8">
            <div class="list-group">
                {% for drawing in xzibit.drawings.all %}
                <div class="list-group-item">
                    <div class="media">
                        <div class="media-left">
                            <a href="#">
                                <img class="media-object" data-src="holder.js/64x64" alt="64x64"
                                     src="{{ drawing.image.url }}" data-holder-rendered="true" style="width: 64px; height: 64px;">
                            </a>
                        </div>
                        <div class="media-body">
                            <h4 class="media-heading">{{ drawing.name }}<a class="anchorjs-link" href="#media-heading"><span class="anchorjs-icon"></span></a></h4>
                            <h5>Жанры:
                                {% for genre in drawing.genres.all %}
                                    <span class="label label-default">{{ genre }}</span>
                                {% endfor %}
                            </h5>
                        </div>
                        <div class="imageBtn pull-right">
                            <button type="button" class="btn btn-danger">
                                <span class="glyphicon glyphicon-remove"></span>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <button type="button" class="btn btn-primary btn-lg pull-right">
                <span class="glyphicon glyphicon-plus"></span>
            </button>
            <button type="button" class="btn btn-success btn-lg pull-left">
                <span class="glyphicon glyphicon-ok">OK</span>
            </button>
        </div>
        <div class="col-lg-4">
            <div class="affix pull-right panel">
                <div class="row">
                    <div class="col-xs-6 col-md-3">
                        <h4>Name</h4>
                        <input type="text" class="form-control" placeholder="Name">
                        <h4>Genres</h4>
                        <ul class="list-group" id="genreList">
                        </ul>
                        <div class="dropdown">
                            <button class="btn btn-primary pull-right" data-toggle="dropdown">
                                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                            </button>
                            <ul id="menu3" class="dropdown-menu pull-right" role="menu" aria-labelledby="drop6">

                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}